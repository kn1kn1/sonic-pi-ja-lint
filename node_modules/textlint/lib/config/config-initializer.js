// LICENSE : MIT
"use strict";

var Promise = require("bluebird");
var fs = require("fs");
var path = require("path");
var ObjectAssign = require("object-assign");
var isFile = require("is-file");
var Config = require("../config/config");
var readPkg = require("read-pkg");
var Logger = require("../util/logger");

/**
 * read package.json if found it
 * @param {string} dir
 * @returns {Promise.<Array.<String>>}
 */
var getTextlintDependencyNames = function getTextlintDependencyNames(dir) {
    return readPkg(dir).then(function (pkg) {
        var dependencies = pkg.dependencies || {};
        var devDependencies = pkg.devDependencies || {};
        var mergedDependencies = ObjectAssign({}, dependencies, devDependencies);
        var pkgNames = Object.keys(mergedDependencies);
        return pkgNames.filter(function (pkgName) {
            var ruleOrFilter = pkgName.indexOf(Config.FILTER_RULE_NAME_PREFIX) !== -1 || pkgName.indexOf(Config.RULE_NAME_PREFIX) !== -1;
            if (pkgName === "textlint-rule-helper") {
                return false;
            }
            return ruleOrFilter;
        });
    }).catch(function () {
        return [];
    });
};

/**
 * create object that fill with `defaultValue`
 * @param {Array} array
 * @param {*} defaultValue
 * @returns {Object}
 */
var arrayToObject = function arrayToObject(array, defaultValue) {
    var object = {};
    array.forEach(function (item) {
        object[item] = defaultValue;
    });
    return object;
};
/**
 * Initializer class for config of textlint.
 */
var init = {
    /**
     * Create .textlintrc file
     * @params {string} dir The directory of .textlintrc file
     * @returns {Promise.<number>} The exit code for the operation.
     */
    initializeConfig: function initializeConfig(dir) {
        return getTextlintDependencyNames(dir).then(function (pkgNames) {
            var rcFile = "." + Config.CONFIG_FILE_NAME + "rc";
            var filePath = path.resolve(dir, rcFile);
            if (isFile(filePath)) {
                Logger.error(rcFile + " is already existed.");
                return Promise.resolve(1);
            }
            var filters = pkgNames.filter(function (pkgName) {
                return pkgName.indexOf(Config.FILTER_RULE_NAME_PREFIX) !== -1;
            }).map(function (filterName) {
                return filterName.replace(Config.FILTER_RULE_NAME_PREFIX, "");
            });
            var rules = pkgNames.filter(function (pkgName) {
                return pkgName.indexOf(Config.RULE_NAME_PREFIX) !== -1;
            }).map(function (filterName) {
                return filterName.replace(Config.RULE_NAME_PREFIX, "");
            });
            var defaultTextlintRc = {
                "filters": arrayToObject(filters, true),
                "rules": arrayToObject(rules, true)
            };
            var output = JSON.stringify(defaultTextlintRc, null, 2);
            fs.writeFileSync(filePath, output);
            return Promise.resolve(0);
        });
    }
};
module.exports = init;
//# sourceMappingURL=config-initializer.js.map